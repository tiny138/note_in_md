# 中断管理
## 1 涉及外设
涉及外设：EXIT 外部中断，NVIC 内嵌向量中断控制器[NVIC（内嵌向量中断控制器）]  
&emsp;计算机的 CPU 处理数据的速度是很快的，但是与 CPU 相连的外部设
备速度却很慢。比如打印机的速度就和 CPU 的速度就相差很多，在没有中断技术 时当打印机在执行打印操作时 CPU 就只能等待打印机操作完成，他才能处理其他 事情，这样 CPU 的效率将会大大降低。有了中断技术之后 CPU 只需在打印机发出 打印请求时，才会处理打印机的数据，处理完成后 CPU 将立即返回主程序处理其 他的事情，这样大大提高了CPU的效率。
<img src = 'picture\6.1.PNG'>  

## 2 中断处理流程
* **保护现场**
保护现场有两个含意，其一是保存程序的断点；其二是保存通用寄 存器和状态寄存器的内容（压栈）。在 STM32 中这一步我们不需要操作 由硬件实现。
* **中断服务程序**
不同的中断，中断服务程序的处理方法不同。中断服务程序也是我 们需要重点设计和编写的，例如我们 DragonFly 与上位机和 ESP8266 通 信就是通过串口实现的，为了保证数据的实时性我们都是用中断处理的。
* **恢复现场** 这是中断服务程序的结尾部分，要求在退出服务程序前，将原程序
中断时的“现场”恢复到原来的寄存器（出栈）。在 STM32 中这一步我们 不需要操作由硬件实现。
 * **中断返回**
中断服务程序的最后一条指令通常是一条中断返回指令，使其返回到原程序的断点处，以便继续执行原程序。但是在上一个中断服务程序 还未返回时又发生了一个更高优先级的中断，此时 CPU 会暂停现在的中 断服务程序，转去处理新中断请求，如图 7-3 所示，只有等到中断 2 服 务程序执行完返回后，才会执行中断 1 服务程序然后返回到主程序

## 3 NVIC
### 3.1 NVIC基本概念
<img src = 'picture\6.2.PNG'>  

Cortex-M4的NVIC支持最多240个**IRQ(中断请求)**、1个不可屏蔽中断（NMI）、
一个 SysTick 定时器中断以及多个系统异常，**一共 256 个中断**。多数 IRQ 由*定时 器、I/O 端口和通信接口（如 USART 和 TIM）等外设*产生。NMI 通常由看门狗定 时器或掉电检测器等外设产生，其余的异常则是来自处理器内核，中断还可以利用软件生成。

### 3.2 NVIC寄存器

STM32F4 并没有没有使用 Cortex-M4 内核的所有中断（256个），而是只使用 了 92 个中断，其中有 10 个不可屏蔽中断，82 个可屏蔽中断，具有 16 级可编程 中断优先级，82 个可屏蔽中断的打开与关闭、挂起等，都是被寄存器控制，这些 寄存都已被标准口封装成 NVIC_Type 的结构体  
1. ISER[8]：这是一个*中断使能寄存器组*。  
8 个 32 位寄存器来控制，每个位控制一个中断 8*32=256  
**具体每一位对应哪个 中断，请参考 stm32f4xx.h 里面的第 196 行处。**
2. ICER[8]：是一个*中断除能寄存器组*。该寄存器组与 ISER 的作用恰好相反， 是用来清除某个中断的使能的。其对应位的功能，也和 ICER 一样。这里要专门 设置一个 ICER 来清除中断位，而不是向 ISER 写 0 来清除，是**因为 NVIC 的这些 寄存器都是写 1 有效的，写 0 是无效的。**
0. ISPR[8]：是一个*中断挂起控制寄存器组*。每个位对应的中断和 ISER 是一
样的。通过置 1，可以将正在进行的中断挂起，而执行同级或更高级别的中断。 写 0 是无效的。
0. ICPR[8]：是一个*中断解挂控制寄存器组*。其作用与 ISPR 相反，对应位也和
ISER 是一样的。通过设置 1，可以将挂起的中断接挂。写 0 无效。
0. IABR[8]：是一个*中断激活标志位寄存器组*。对应位所代表的中断和 ISER
一样，如果为 1，则表示该位所对应的中断正在被执行。这是一个**只读寄存器**， 通过它可以知道当前在执行的中断是哪一个。在中断执行完了由硬件自动清零