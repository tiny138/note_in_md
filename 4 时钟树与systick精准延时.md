<!--
 * @Author: your name
 * @Date: 2021-01-23 21:11:19
 * @LastEditTime: 2021-01-23 21:39:33
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \markdown\4 时钟树与systick精准延时.md
-->
# 时钟树与systick精确延时
## 1 涉及外设
&emsp;RCC(复位时钟控制)、SysTick 定时器  
&emsp;GPIO 和串口，我们发现这两个外设初始化之前都会有一 个时钟初始化，并且不同的外设所挂载的总线下的时钟也不一样。

### 1.1 时钟系统简介
* 51 一个系统时钟
* stm32 多个时钟系统，因为：因为首先 STM32 本身非常复杂，外设非常的多，但是**并不是所有外设都需要系统时钟这 么高的频率**，比如看门狗以及 RTC 只需要几十 k 的时钟即可。**同一个电路， 时钟越快功耗越大，同时抗电磁干扰能力也会越弱，所以对于较为复杂的 MCU 一般都是采取多时钟源的方法来解决这些问题**

在 STM32F411 中有一共有 5 个时钟源，分别为 HSI、HSE、LSI、LSE、PLL。 这五个时钟源为整个时钟系统提供时钟源头。
1. LSI 是**低速内部时钟**，RC 振荡器，频率为 32kHz 左右。*供独立看门狗和 自动唤醒单元使用*。
2. LSE 是**低速外部时钟**，接频率为 32.768kHz 的石英晶体。 这个主要是 *RTC 的时钟源*。
3. HSE 是**高速外部时钟**，可接石英/陶瓷谐振器，或者接外部时钟源，频率 范围为 4MHz~26MHz。我们的 DragonFly 学习平台接的是 8M 的晶振。HSE 也可以直接做为*系统时钟或者 PLL 输入*。
4. HSI 是**高速内部时钟**，RC 振荡器，频率为 16MHz。可以直接作为*系统时钟或者用作 PLL 输入*。
5. PLL 为锁相环倍频输出。 STM32F411 有两个 PLL：
* 主 PLL(PLL)由 HSE 或者 HSI 提供时钟信号，并具有两个不同的输 出时钟。 第一个输出 PLLP 用于生成高速的系统时钟（最高 100MHz） 第二个输出 PLLQ 用于生成 USB OTG FS 的时钟（48MHz），随机数 发生器的时钟和 SDIO 时钟。
* 专用 PLL(PLLI2S)用于生成*精确时钟*，从而在 I2S 接口实现高品质 音频性能

&emsp;**其实以上讲的系统时钟初始化配置完全不需要我们手动配置，STM32 标准库 中都已用函数封装好了，并且在系统启动文件里自动调用，这也就是为什么前面 讲解 GPIO 和串口时没有初始化时钟但我们写的程序一样能运行。**

## 2 systick 系统定时器
&emsp;SysTick—系统定时器是属于 CM4 内核中的一个外设，定时器是属于 CM4 内核的外设，所以有关寄存器的定义和配置函数在`core_cm4.h` 文件中。

一般我们设置系统时钟 SYSCLK 等于 100MHz。**当重装载数值寄存器的 值递减到 0 的时候，系统定时器就产生一次中断，以此循环往复**