# IIC协议
## 1 协议简介
&emsp;IIC 通讯协议(Inter－Integrated Circuit)是由 Philips 公司开发的， 由于它*引脚少，硬件实现简单，可扩展性强，不需要 USART、 CAN 等通讯协议 的外部收发设备*，现在被广泛地使用在系统内多个集成电路(IC)间的通讯

### 1.1 协议的物理层
<img src = 'picture\7.1.PNG'>   

特点：  
* 在一个 IIC通讯 总线中，可连接多个 IIC 通讯设备，支持多个通讯主机及多个通讯从机
* 串行时钟线 (SCL)；双向串行数据线(SDA)
* 地址访问设备
* 仲裁方式决定总线的使用权
* 三种模式：标准、快速、高速

### 1.2 协议的协议层
<img src = 'picture\7.2.PNG'>   

信号解读：  
1. **起始信号(S)**：表示由主机的 IIC 接口产生的传输，这时连接到 IIC 总线上的*所有从机*都会 接收到这个信号。
0. **从机地址(SLAVE ADDRESS)**：起始信号产生后，所有从机就开始等待主机紧接下来广播的 从机地址信号(SLAVE ADDRESS)。相同时，这个设备就被选中了，*没被选中的设备将会忽略之后的数 据信号*。IIC 协议规定从机地址可以是 7 位或 10 位。
0. **传输方向选择位(R/W)**：在地址位之后是传输方向的选择位，该位为 0 时，表示后面的数 据传输方向是由主机写数据到从机。该位为 1 时，即主机由从机读数据
0. **应答信号(A)**：看模式是否需要应答信号才发信号
0. **非应答信号(NACK)**：主机由从机读取数据时：主机接收完最后一个字节，必须产生一个非 应答(NACK)芯片信号，用来*通知从机不要再发数据了*，这样从机也就释放了 SDA。
0. **停止信号(P)**：所有数据都传输完成时，主机会给出一个停止信号，用于结束此次通信。

**总结**：IIC 通讯中，SDA 和 SCL *都是由主机控制*的，从设备只是能够将 SDA 线拉低而已。 对于 SCL 线，从机是没有任何能力去控制的。从机只能被动跟随 SCL。地址为一般是*7位*，后面跟着*读写位*。当设备(无论主从机)接收到 IIC 传 输的地址数据后，若希望对方继续发送数据，则需要向对方发送 “应答(ACK)”信号，发送方会继续发送下一个数据；若接收端希望结束数据 传输，则向对方发送“非应答(NACK)”信号，发送方接收到该信号后会产生 一个停止信号，结束信号传输

## 2 GPIO模拟IIC时序
&emsp;我们知道 STM32F4 自带 IIC 硬件接口，通信速度最高能达到 400kHz。但是 也有其**缺点**：就是通用性不是很好，不同芯片的配置不同，引脚固定。所以我们选 择了用 IO 口模拟 IIC,它具有通用性强，移植方便，可用任意 IO 引脚模拟等特 点，**缺点**:速度赶不上硬件IIC，但是度MPU足够。

### 2.1 编程
&emsp; IIC 一共就**两条线**分别为 SDA 与 SCL，所以只需要**两个 IO 口**，其
中 SDA 为数据线，主机从机都可控制，既需要输出又需要输入，所以模拟时需要 有 IO 输入与输出的模式切换。**SCL 为时钟线**，由仅主机控制输出，所以只需要 配置成**输出模式**。

&emsp;四轴学习平台用的是 **PB6 模拟 SCL 线**，**PB7 模拟 SDA 线**

>1. GPIO 初始化模式,PB6、PB7均为推挽

>2. SDA 线输入输出模式转换（因为需要输入输出转换），最快改变 IO 模式的方法，也就是**直接操作寄存器**了，

SDA控制权，发数据时：发送端；发ACK时：接收端

> 3. `IIC_ReadByteFromSlave`IIC复合通信的例子，照着通信格式写的

四个主要函数：
```C
uint8_t IIC_ReadByteFromSlave(uint8_t I2C_Addr,uint8_t reg,uint8_t *buf);
uint8_t IIC_ReadMultByteFromSlave(uint8_t dev, uint8_t reg, uint8_t length, uint8_t *data);
uint8_t IIC_WriteByteToSlave(uint8_t I2C_Addr,uint8_t reg,uint8_t buf);
uint8_t IIC_WriteMultByteToSlave(uint8_t dev, uint8_t reg, uint8_t length, uint8_t* data);
```