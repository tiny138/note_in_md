# stm32定时器
## 定时器基本概念
* 高级计时器 TIM1 TIM8
* 通用计时器 TIM2~TIM5
* 基本计时器 TIM6 TIM7

## 通用计数器(主要是中断部分)
&emsp;STM32F1 的通用定时器是一个通过**可编程预分频器-PSC** *驱动* 的 **16 位自动装载计数器
-CNT**构成。STM32 的每个通用定时器都是**完全独立的**，
没有互相共享的任何资源。  
功能：4 个独立通道（TIMx_**CH1~4**）均可用来
* **输入捕获**：测量输入信号的脉冲长度
* **输出比较和 PWM**：产
生输出波形
* **单脉冲模式输出**

重要寄存器：
* **TIMx_CR1**（是控制寄存器 1）：0：计数器使能位CEN；4：DIR ；[8:9]:分频因子1,2,4；
* **TIMx_DIER**（DMA/中断使能寄存器）：仅关心它的第 0 位，该位是更新中断允许位
* **TIMx_CNT**（16 位向上、向下、向上/向下自动装载计数器）：存储了当前
定时器的计数值
* **TIMx_PSC**(16 位可编程(可以实时修改)预分频器)，计数器时钟频率的分频系数为 1～
65535 之间的任意数值。**psc：时钟预分频数**
* **TIMx_ARR**（自动重装载寄存器）：更新事件（UEV）时，才把预装在寄存器的内容传送到影子寄存器，**arr：自动重装值**
>进入中断的时间：Tout= (arr+1)/(Tclk/(psc+1))；

* **TIMx_SR**：寄存器用来标记当前与定时
器相关的各种事件/中断是否发生  
&emsp;库函数主要集中在固件库文件 `stm32f10x_tim.h` 和 `stm32f10x_tim.c` 文件
中

两个函数的差异：`TIM_GetITStatus` 函数中会先判断这种中断是否使能，使能了才去判断中断标志位，而
`TIM_GetFlagStatus` 直接用来判断状态标志位，步骤不一样，但是都可以用来判断中断标志位

发生中断的条件：
* **更新**：计数器向上溢出/向下溢出，计数器初始化
* **触发事件**(计数器启动、停止、初始化或者由内部/外部触发计数)
* **输入捕获**
* **输出比较**
...
中断程序示例
```C
//定时器 3 中断服务程序⑥
void TIM3_IRQHandler(void) //TIM3 中断
{
    if (TIM_GetITStatus(TIM3, TIM_IT_Update) != RESET) //检查 TIM3 更新中断发生与否
    {
       TIM_ClearITPendingBit(TIM3, TIM_IT_Update ); //清除 TIM3 更新中断标志
        LED1=!LED1;
    } 
}
```

## PWM输出
&emsp;STM32 的定时器除了 TIM6 和 7。其他的定时器都可以用来产生 PWM 输出。其中**高级**定
时器 TIM1 和 TIM8 可以同时产生多达 **7** 路的 PWM 输出。而**通用**定时器也能同时产生多达 **4**
路的 PWM 输出，这样，STM32 最多可以**同时产生 30 路** PWM 输出！

相关寄存器，除了上述之前的寄存器，还有：
* **TIMx_CCMR1/2** 捕获/比较模式寄存器：该寄存器总共有 **2** 个，**TIMx _CCMR1**
和 **TIMx _CCMR2**。TIMx_CCMR1 控制 CH1 和 2，而 TIMx_CCMR2 控制 CH3 和 4。
该寄存器的有些位在不同模式下，功能不一样，PWM 模式，所以这 3 位必须设置为 110/111。极性
* **TIMx_CCER** 捕获/比较**使能**寄存器：
* **TIMx_CCR1~4** 捕获/比较寄存器：